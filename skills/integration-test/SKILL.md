---
name: integration-test
description: |
  結合テスト（IT）スキル。実装完了報告書（IMP）と詳細設計書（DSD）を入力とし、
  フロントエンド/バックエンド間・API・外部システム連携の結合テストを実施し、
  結合テスト仕様・結果書（IT-001〜IT-003）を出力する。

  以下の場合に使用する：
  - 「結合テストして」「ITフェーズを実施して」「IT-001を作成して」などの依頼
  - 実装完了報告書（IMP-001/IMP-002）が揃っている機能の結合テスト
  - FE/BE 連携・API 動作・外部システム連携の検証
  - 結合テスト完了後に IT-001〜IT-003 を作成する場合

  入力: IMP-001_{FEAT-ID}, IMP-002_{FEAT-ID}, DSD-003_{FEAT-ID}, DSD-005_{FEAT-ID}（該当時）
  出力: projects/PRJ-{NNN}/IT/ 以下の IT-001〜IT-003
  配置ルール・ドキュメント定義 → references/document-list.md
---

# 結合テストスキル（IT）

## 概要

実装完了報告書と詳細設計書を読み込み、機能ごとに結合テストを実施し、テスト仕様・結果書を作成する。

参照ファイル：
- IT ドキュメントテンプレート → `references/it-templates.md`
- 配置ルール・ドキュメント定義 → `references/document-list.md`

## パラメータ

| パラメータ | 説明 | 例 |
|---|---|---|
| PROJECT_ID | プロジェクトID | PRJ-001 |
| PROJECT_NAME | プロジェクト名 | initial-build |
| FEAT_ID | 機能ID（IT-002 横断モード時は空欄） | FEAT-001 |
| FEAT_NAME | 機能名（IT-002 横断モード時は空欄） | user-auth |

## エージェント起動

このスキルは以下のサブエージェントを使用して作業を実行する。FEAT 単位モード（IT-001）と横断モード（IT-002）の 2 つの起動モードがある。

| サブエージェント | タイプ | プロンプト |
|---|---|---|
| IT 実行エージェント | general-purpose | `agents/integration-test.md` |

### 起動手順

1. `agents/integration-test.md` を Read で読み込む
2. `{{PROJECT_ID}}`, `{{PROJECT_NAME}}`, `{{FEAT_ID}}`, `{{FEAT_NAME}}` を実際の値に置換する（横断モード時は FEAT_ID/FEAT_NAME を空欄にする）
3. 以下の形式で Task ツールを呼び出してサブエージェントを起動する

> **重要**: このスキルの作業はすべてサブエージェントに委譲する。マスターエージェントが直接実行してはならない。

Task ツール呼び出し（FEAT 単位モード）:
- `subagent_type`: `"general-purpose"`
- `description`: `"IT 結合テスト {FEAT_ID} 実行"`（例: `"IT 結合テスト FEAT-001 実行"`）
- `prompt`: 置換済みの agents/integration-test.md の内容全文

Task ツール呼び出し（横断モード・IT-002）:
- `subagent_type`: `"general-purpose"`
- `description`: `"IT API横断テスト実行"`
- `prompt`: 置換済みの agents/integration-test.md の内容全文（FEAT_ID/FEAT_NAME を空欄にした版）

### 複数 FEAT の並行起動

複数 FEAT を処理する場合、FEAT ごとに独立した Task ツールを**同一メッセージ内で並行に**呼び出す。

例（FEAT-001 と FEAT-002 を並行実行）:
- Task 1: `subagent_type: "general-purpose"`, `description: "IT 結合テスト FEAT-001 実行"`, `prompt: （FEAT-001 用に置換した agents/integration-test.md）`
- Task 2: `subagent_type: "general-purpose"`, `description: "IT 結合テスト FEAT-002 実行"`, `prompt: （FEAT-002 用に置換した agents/integration-test.md）`

## 並行作業スコープ

**IT-001 は 1回の起動で 1つの FEAT-ID を担当する。**
複数の FEAT-ID は別セッションで並行して進める。

IT-002・IT-003 の扱いは以下の通り：

```
並行作業の例（FEAT-001 と FEAT-002 を同時に進める）:
  セッション A: FEAT-001 担当 → IT-001_FEAT-001 を作成、IT-003 へ不具合追記
  セッション B: FEAT-002 担当 → IT-001_FEAT-002 を作成、IT-003 へ不具合追記
  全 IT-001 完了後: IT-002（API結合テスト）を作成
```

| ドキュメント | 並行作業 | 作成タイミング |
|---|---|---|
| IT-001_{FEAT-ID} | 各 FEAT 独立・並行可 | 対象 FEAT の実装完了後すぐ |
| IT-002 | 全 IT-001 完了後に単独作成 | 全機能の IT-001 完了後 |
| IT-003 | 全 FEAT 共通・随時追記 | テスト中に不具合を発見した都度 |

## 前提確認

結合テスト開始前に以下を確認する：

1. **対象 FEAT-ID の確認**: どの機能（FEAT-{NNN}）をテストするか
2. **プロジェクト ID の確認**: PRJ-{NNN} と出力先ディレクトリ
3. **実装完了の確認**: IMP-001_{FEAT-ID} と IMP-002_{FEAT-ID} が存在し完了していること
4. **テスト環境の確認**: テスト用環境が起動していること（IMP-003 参照）
5. **外部システム連携の有無**: DSD-005_{FEAT-ID} が存在するか（外部IF使用機能のみ）
6. **IT-003 の状態確認**: 既存の IT-003 があれば追記モードで使用する

## 入力ドキュメントの読み込み方針

```
最初に読む（スコープ把握）
  projects/PRJ-{NNN}/IMP/FEAT-{NNN}_{機能名}/IMP-001_{FEAT-ID}_{機能名}.md  ← BE実装・申し送り確認
  projects/PRJ-{NNN}/IMP/FEAT-{NNN}_{機能名}/IMP-002_{FEAT-ID}_{機能名}.md  ← FE実装・申し送り確認
  projects/PRJ-{NNN}/BSD/BSD-008_test-plan.md                               ← テスト方針・品質基準確認

テスト設計時に参照する
  docs/DSD/FEAT-{NNN}_{機能名}/DSD-003_{FEAT-ID}_{機能名}.md  ← API仕様（エンドポイント詳細）
  docs/DSD/FEAT-{NNN}_{機能名}/DSD-005_{FEAT-ID}_{機能名}.md  ← 外部IF仕様（該当機能のみ）
```

> IMP の「申し送り事項」セクションに記載された注意点を必ず確認してからテスト設計を開始する。

## テストワークフロー（IT-001）

### ステップ 1: テストシナリオリストを作る

IMP-001/002 の申し送り事項と DSD-003 のエンドポイント一覧を元に、テストシナリオの TODO リストを作る。

```
[ ] ログイン画面 → POST /api/auth/login → JWTトークン受取 → マイページ遷移  ← まずこれ
[ ] 無効なパスワードで POST /api/auth/login → 401 エラー表示
[ ] 外部認証サービス連携（DSD-005 で外部IF使用時のみ）
...（テスト中に気づいたケースを随時追記）
```

テストケース ID は `ITC-{NNN}` 形式（機能内で連番）で採番する。

### ステップ 2: テスト仕様を設計する

テストシナリオごとに以下を定義する：

| 定義項目 | 内容 |
|---|---|
| 前提条件 | テスト実行前の DB 状態・セッション・テストデータ |
| 操作手順 | FE 操作 → API 呼び出し → レスポンス確認の具体的な手順 |
| 期待値 | HTTP ステータス・レスポンス内容・画面表示・DB 変化 |

テスト仕様と結果は **同一テーブルに共存させる**（仕様設計後に結果列を埋める）。

### ステップ 3: テストを実施する

1. テスト環境を確認し、必要なテストデータを準備する
2. 各テストケースを実行し、結果（OK / NG / SKIP）を記録する
3. NG の場合は IT-003 に不具合を登録し、BUG-ID を記録する
4. **重大度「高」の不具合はただちにユーザーに報告する**

### ステップ 4: 完了判定

| 判定基準 | 内容 |
|---|---|
| PASS 条件 | 全 ITC が OK または SKIP（SKIP は理由必記） |
| FAIL 条件 | NG が残存（保留不具合は IT-003 に記録し ST 申し送り） |
| 品質基準 | BSD-008 の IT 合格基準を参照 |

## API 結合テストワークフロー（IT-002）

**全 IT-001 が完了した後に実施する。**

### ステップ 1: 全エンドポイントを横断整理する

全 FEAT-ID の DSD-003 と IT-001 を参照し、全 API エンドポイントを一覧化する。

```
クロス機能テストシナリオ（XS-{NNN} 形式）の例:
  XS-001: ユーザー登録 → ログイン → プロフィール取得（複数 FEAT をまたぐシナリオ）
  XS-002: 商品登録 → 注文 → 在庫更新（FEAT 間の状態依存シナリオ）
```

### ステップ 2: クロス機能テストを実施する

クロス機能テストケース ID は `ATC-{NNN}` 形式で採番する。

- FEAT をまたぐ連携シナリオを重点的に検証する
- エンドポイント網羅チェックリストで未テストの API を確認する

### ステップ 3: エンドポイント網羅を確認する

全エンドポイントがいずれかの IT-001 または IT-002 でテストされていることを確認する。
未テストのエンドポイントは SKIP として理由を記載する。

## 不具合管理（IT-003）

不具合 ID は `BUG-{NNN}` 形式でプロジェクト内連番（IT-003 全体で通番）。

| 重大度 | 定義 | 対応方針 |
|---|---|---|
| 高 | 機能が動作しない / クリティカルな結合不具合 | **即時ユーザー報告** + 修正待ち |
| 中 | 機能は動作するが DSD 仕様と異なる / 一部シナリオが失敗 | テスト継続・修正後に再テスト |
| 低 | 軽微な表示差異・DSD との細かな乖離 | テスト継続・ST 申し送り検討 |

IT-003 は **全 FEAT セッションで共有するファイル**。並行作業時は追記時に競合しないよう注意する。

## 出力ドキュメントの作成

`references/it-templates.md` のテンプレートを使い、以下を作成する：

| ドキュメント | 作成タイミング | 配置先 | 並行作業 |
|---|---|---|---|
| IT-001_{FEAT-ID}_{機能名}.md | 当該 FEAT の結合テスト完了後 | `projects/PRJ-{NNN}/IT/FEAT-{NNN}_{機能名}/` | 各 FEAT 独立 |
| IT-002_api-integration-test.md | 全 IT-001 完了後 | `projects/PRJ-{NNN}/IT/` | 単独作成 |
| IT-003_defect-list.md | テスト中に不具合発生の都度更新 | `projects/PRJ-{NNN}/IT/` | 全 FEAT 共通（随時追記） |

## 設計差異・仕様変更の記録原則

テスト中に DSD との差異が生じた場合：

1. **観察事項として記録する**: IT-001 の「テスト観察事項」セクションに差異内容・理由を記載する
2. **重大な乖離はユーザーに確認する**: 仕様変更が必要な場合は DSD を更新し、変更理由を記録する
3. **軽微な乖離は申し送りに記載する**: ST フェーズの「申し送り事項」として次フェーズに引き継ぐ

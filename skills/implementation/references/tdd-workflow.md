# TDD ワークフロー詳細ガイド

## TDD の基本原則

- **テストファースト**: 実装コードより先にテストを書く
- **最小実装**: そのテストを通すだけの最小限のコードを書く
- **小さなステップ**: 1テストケースずつ進める（大きく飛び越えない）
- **常に GREEN を保つ**: リファクタリング中もテストが通り続けること

## Red → Green → Refactor サイクル詳細

### Red フェーズ

**目的**: 意図した理由で失敗するテストを書く

```
1. DSD-008 から1テストケースを選ぶ
2. テストコードを書く
3. テストを実行して「失敗」することを確認する
4. 失敗理由が「実装がない」ことによるものか確認する
   ✅ 正しい失敗: AssertionError, NameError, NotImplementedError
   ❌ 誤った失敗: SyntaxError, ImportError（テストコード自体のバグ）
```

テスト名の命名規則（DSD-008 のテストケースIDと対応させる）：
```
# DSD-008 のテストケースID が TC-001 の場合
def test_TC001_正常系_ユーザー登録_有効なメールアドレス():
    ...
```

### Green フェーズ

**目的**: そのテストだけを通す最小限の実装

```
1. テストを通す最小限のコードを書く（完璧でなくてよい）
2. テストを実行して「成功」することを確認する
3. 他のテストが壊れていないことを確認する（全テスト実行）
4. DSD との差異が生じた場合は差異メモに記録する
```

差異メモの記録フォーマット：
```
[差異メモ]
- 対象: {クラス名/関数名}
- DSD 仕様: {DSD に記載された内容}
- 実装内容: {実際の実装}
- 理由: {差異が生じた理由}
- 影響: {他への影響、要確認事項}
```

### Refactor フェーズ

**目的**: 振る舞いを変えずにコードを整える

チェックリスト（DSD-007 に沿って確認）：

```
□ 命名規則に従っているか（DSD-007 参照）
□ 重複コードを排除できるか
□ 関数/メソッドが単一責任になっているか
□ マジックナンバーが定数化されているか
□ エラーハンドリングが DSD-001/002 の仕様通りか
□ ログ出力が設計通りか
□ 全テストが GREEN のままか（必ず確認）
```

---

## バックエンド TDD の実践パターン

### レイヤー別の実装順序

DSD-001 のアーキテクチャに従い、依存関係の下位レイヤーから実装する：

```
1. ドメイン層（エンティティ・値オブジェクト・ドメインサービス）
   ↓ テスト: ビジネスルールのユニットテスト（外部依存なし）

2. インフラ層（リポジトリ実装・DB アクセス）
   ↓ テスト: DB をモック/インメモリDBで置き換えたテスト

3. アプリケーション層（ユースケース・サービス）
   ↓ テスト: リポジトリをモックしたユニットテスト

4. プレゼンテーション層（コントローラ・ハンドラ）
   ↓ テスト: HTTPリクエスト/レスポンスのテスト（DSD-003 に基づく）
```

### モック・スタブの使用方針（DSD-008 参照）

```python
# 外部依存はモック化する原則
# DB: インメモリ DB またはリポジトリのモック
# 外部API: スタブ・モック（DSD-005 の仕様に基づくレスポンスを返す）
# 時刻: テスト用の固定時刻を注入する
# メール・通知: モック化して送信しない
```

### API テストパターン（DSD-003 に基づく）

```
各エンドポイントに対して以下のテストケースを網羅する：
- 正常系: 正しいリクエスト → 期待するレスポンスとステータスコード
- バリデーションエラー: 不正な入力 → 400 Bad Request
- 認証エラー: 未認証リクエスト → 401 Unauthorized
- 権限エラー: 権限不足 → 403 Forbidden
- Not Found: 存在しないリソース → 404 Not Found
- 重複エラー: 既存データとの衝突 → 409 Conflict
```

---

## フロントエンド TDD の実践パターン

### コンポーネントテストの順序（DSD-002 に基づく）

```
1. 最小コンポーネント（UIパーツ）から実装
   ↓ テスト: レンダリング・Props・スナップショット

2. フォーム・インタラクション
   ↓ テスト: ユーザー操作・バリデーション・送信

3. API 連携（DSD-003 の仕様に基づく）
   ↓ テスト: API をモック化してデータ取得・エラー状態

4. ページ/画面コンポーネント
   ↓ テスト: ルーティング・ページ全体のレンダリング
```

### コンポーネントテストのチェックリスト

```
□ 正常データでのレンダリング
□ ローディング状態の表示
□ エラー状態の表示（API エラー時）
□ 空データ時の表示（0件リスト等）
□ ユーザー操作（クリック・入力・送信）
□ バリデーションエラーメッセージの表示
□ アクセシビリティ（aria-label 等）
```

---

## DB マイグレーション TDD

DSD-004 のテーブル定義をもとにマイグレーションを作成する：

```
1. マイグレーションファイルを作成する
2. マイグレーション実行テストを書く（テスト DB に対して実行・ロールバック）
3. マイグレーション実行後のスキーマが DSD-004 の定義通りか確認する
4. ロールバックスクリプトが正しく動作するか確認する
5. IMP-004 にスクリプト一覧・実行順序・ロールバック手順を記載する
```

---

## 実装完了の定義（Done の基準）

機能の実装完了とみなす条件：

```
□ DSD-008 の全テストケースが GREEN
□ DSD-007 のコーディング規約に準拠している
□ DSD-001/002 の設計と照合し、差異を IMP-001/002 に記録した
□ コードレビュー基準（DSD-007 参照）を満たしている
□ IMP-001/002 の実装完了報告書を作成した
□ DB 変更がある場合: IMP-004 にマイグレーション手順を追記した
□ 初回構築の場合: IMP-003 に環境構築手順を記載した
```

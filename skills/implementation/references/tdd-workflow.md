# TDD ワークフロー詳細ガイド

## TDD の基本原則

- **テストファースト**: 実装コードより先にテストを書く
- **最小実装**: そのテストを通すだけの最小限のコードを書く（ハードコードで可）
- **小さなステップ**: 1テストケースずつ進める（大きく飛び越えない）
- **常に GREEN を保つ**: リファクタリング中もテストが通り続けること
- **アーキテクチャは後から**: テストを重ねることで自然に構造が浮かび上がる

## Red → Green → Refactor サイクル詳細

### Red フェーズ

**目的**: 意図した理由で失敗するテストを書く

```
1. DSD-008 から1テストケースを選ぶ（最も簡単な正常系から）
2. テストコードを書く（1テストのみ）
3. テストを実行して「失敗」することを確認する
4. 失敗理由が「実装がない」ことによるものか確認する
   ✅ 正しい失敗: AssertionError, NameError, NotImplementedError
   ❌ 誤った失敗: SyntaxError, ImportError（テストコード自体のバグ）
```

テスト名の命名規則（DSD-008 のテストケースIDと対応させる）：
```
# DSD-008 のテストケースID が TC-001 の場合
def test_TC001_正常系_ユーザー登録_有効なメールアドレス():
    ...
```

### Green フェーズ

**目的**: そのテストだけを通す最小限の実装（ハードコードで十分）

```
1. テストを通す最小限のコードを書く
   → ハードコードで構わない（例: return True, return [], return "fixed"）
   → 汎化は次のテストが強制するまで行わない
2. テストを実行して「成功」することを確認する
3. 他のテストが壊れていないことを確認する（全テスト実行）
4. DSD との差異が生じた場合は差異メモに記録する
```

**Fake it パターン**（最初は偽の実装で構わない）：
```python
# TC-001: add(1, 2) == 3 を通すための最小実装
def add(a, b):
    return 3  # ハードコード。次のテストが汎化を強制する

# TC-002: add(2, 3) == 5 → 上のハードコードが壊れる → 汎化
def add(a, b):
    return a + b  # 三角測量により汎化
```

差異メモの記録フォーマット：
```
[差異メモ]
- 対象: {クラス名/関数名}
- DSD 仕様: {DSD に記載された内容}
- 実装内容: {実際の実装}
- 理由: {差異が生じた理由}
- 影響: {他への影響、要確認事項}
```

### Refactor フェーズ

**目的**: 振る舞いを変えずにコードを整える

チェックリスト（DSD-007 に沿って確認）：

```
□ 命名規則に従っているか（DSD-007 参照）
□ 重複コードを排除できるか
□ 関数/メソッドが単一責任になっているか
□ マジックナンバーが定数化されているか
□ エラーハンドリングが DSD-001/002 の仕様通りか
□ ログ出力が設計通りか
□ 全テストが GREEN のままか（必ず確認）
```

---

## 三角測量（Triangulation）

ハードコードを汎化させる技法。**同じ実装を壊す2つ目のテストを書くことで、正しい汎化を強制する。**

```
イテレーション 1:
  テスト: total([10]) == 10
  実装: return 10  （ハードコード）

イテレーション 2:
  テスト: total([10, 20]) == 30  ← これが "三角測量"
  実装: return sum(items)  （ハードコードが壊れるので汎化）

イテレーション 3:
  テスト: total([]) == 0  ← 空リストのエッジケース
  実装: return sum(items)  （既存実装で通れば変更不要）
```

**三角測量の選び方**:
- ハードコードで GREEN になった直後は、そのハードコードを壊すテストを選ぶ
- 新しい入力値・境界値・逆方向の条件を使う
- 一般化の方向を1つずつ確認する

---

## バックエンド TDD の実践パターン

### 構造はテストから自然に生まれる

TDD では事前にレイヤー構造を決めない。テストを1つ書くたびに最小限のコードを追加し、**リファクタリングの中で自然にレイヤーが分離していく。**

```
イテレーション 1〜3: 関数1つで動く（レイヤーなし）
イテレーション 4〜6: ロジックとDBアクセスが混在してきたら分離
イテレーション 7〜: テストのモック化が必要になったらリポジトリ抽象化
```

> DSD-001 のアーキテクチャはゴール（あるべき最終構造）として参照する。
> ただし実装はそこに向けて小さく育てる。最初から作らない。

### モック・スタブの導入タイミング

```
外部依存が増えてテストが遅くなった / 非決定的になった → その時点でモック化
最初からモックを作り込まない
```

モック化の原則：
```python
# 外部依存はモック化する原則
# DB: インメモリ DB またはリポジトリのモック
# 外部API: スタブ・モック（DSD-005 の仕様に基づくレスポンスを返す）
# 時刻: テスト用の固定時刻を注入する
# メール・通知: モック化して送信しない
```

### API テストパターン（DSD-003 に基づく）

```
各エンドポイントに対して以下のテストケースを網羅する：
- 正常系: 正しいリクエスト → 期待するレスポンスとステータスコード
- バリデーションエラー: 不正な入力 → 400 Bad Request
- 認証エラー: 未認証リクエスト → 401 Unauthorized
- 権限エラー: 権限不足 → 403 Forbidden
- Not Found: 存在しないリソース → 404 Not Found
- 重複エラー: 既存データとの衝突 → 409 Conflict
```

---

## フロントエンド TDD の実践パターン

### コンポーネントは最小単位から育てる

```
イテレーション 1: 静的レンダリングのテスト（props を受け取って表示）
イテレーション 2: ユーザー操作のテスト（クリック・入力）
イテレーション 3: API 連携のテスト（モックで）
イテレーション 4: エラー・空状態のテスト
```

> ページ全体・ルーティングのテストは最後。最小コンポーネントが GREEN になってから組み合わせる。

### コンポーネントテストのチェックリスト

```
□ 正常データでのレンダリング
□ ローディング状態の表示
□ エラー状態の表示（API エラー時）
□ 空データ時の表示（0件リスト等）
□ ユーザー操作（クリック・入力・送信）
□ バリデーションエラーメッセージの表示
□ アクセシビリティ（aria-label 等）
```

---

## DB マイグレーション TDD

DSD-004 のテーブル定義をもとにマイグレーションを作成する：

```
1. マイグレーションファイルを作成する
2. マイグレーション実行テストを書く（テスト DB に対して実行・ロールバック）
3. マイグレーション実行後のスキーマが DSD-004 の定義通りか確認する
4. ロールバックスクリプトが正しく動作するか確認する
5. IMP-004 にスクリプト一覧・実行順序・ロールバック手順を記載する
```

---

## アンチパターン

TDD を形骸化させる典型的なミスを避ける：

```
❌ テストをまとめて書く
   → 1サイクル1テスト。複数まとめると Green の意味が薄れる

❌ 最初から汎用的な実装を書く
   → まずハードコード。汎化は次のテストが強制したときに行う

❌ 事前にアーキテクチャを全部設計する
   → 構造はリファクタリングで育てる。DSD-001 はゴールとして参照するだけ

❌ DSD を全部読んでから実装を始める
   → 現在のテストに必要な箇所だけ読む。読みすぎると先取り実装になる

❌ テストが RED のまま次のテストに進む
   → 必ず GREEN を確認してから次へ。RED のまま進むと何が壊れているか分からなくなる

❌ Refactor で振る舞いを変える
   → リファクタリングは構造の整理のみ。全テスト GREEN のまま維持する
```

---

## 実装完了の定義（Done の基準）

機能の TDD サイクル完了とみなす条件：

```
□ DSD-008 の全テストケースが GREEN
□ DSD-007 のコーディング規約に準拠している
□ DSD-001/002 の設計と照合し、差異を IMP-001/002 に記録した
□ コードレビュー基準（DSD-007 参照）を満たしている
□ IMP-001/002（実装・単体テスト完了報告書）を作成した
  └ テストケース一覧（DSD-008 対応）・カバレッジ・テストコード配置を含む
□ TDD 中に発見した不具合を IMP-005（TDD不具合管理票）に記録した
□ DB 変更がある場合: IMP-004_FEAT-{NNN}_draft.md にマイグレーション下書きを作成した
□ 初回構築の場合: IMP-003 に環境構築手順を記載した
```

---
name: implementation
description: |
  実装スキル。詳細設計書（DSD）を入力とし、テスト駆動開発（TDD）の Red→Green→Refactor サイクルで実装を進め、実装完了報告書（IMP）を出力する。

  以下の場合に使用する：
  - 「実装して」「TDDで開発して」「コードを書いて」などの依頼
  - 詳細設計書（DSD-001〜DSD-008）が揃っている機能の実装
  - バックエンド・フロントエンド・DB マイグレーションの実装
  - 実装完了後に IMP-001〜IMP-005 の報告書を作成する場合

  単体テストは実装と同時に完了する（TDD統合）。UT フェーズは存在しない。

  入力: docs/DSD/ 以下の DSD-001〜DSD-008
  出力: projects/PRJ-{NNN}/IMP/ 以下の IMP-001〜IMP-005
  配置ルール・ドキュメント定義 → references/document-list.md
---

# 実装スキル（TDD）

## 概要

詳細設計書を読み込み、TDD サイクルで機能ごとに実装し、実装完了報告書を作成する。

参照ファイル：
- TDD サイクル詳細 → `references/tdd-workflow.md`
- IMP ドキュメントテンプレート → `references/imp-templates.md`
- 配置ルール・ドキュメント定義 → `references/document-list.md`

## 並行作業スコープ

**このスキルは 1回の起動で 1つの FEAT-ID を担当する。**
複数の FEAT-ID は別セッションで並行して進める。

```
並行作業の例（FEAT-001 と FEAT-002 を同時に進める）:
  セッション A: FEAT-001 担当 → IMP-001_FEAT-001, IMP-002_FEAT-001 を作成
  セッション B: FEAT-002 担当 → IMP-001_FEAT-002, IMP-002_FEAT-002 を作成
  最後にまとめ: IMP-004 に両機能のマイグレーションを統合
```

**IMP-004（DB マイグレーション）は競合注意**:
- 各セッションは自分の FEAT-ID 分のマイグレーションを `IMP-004_FEAT-{NNN}_draft.md` として作成する
- 全 FEAT-ID の実装完了後、プロジェクト担当者が実行順序を調整して `IMP-004_db-migration.md` に統合する

## 前提確認

実装開始前に以下を確認する：

1. **対象 FEAT-ID の確認**: どの機能（FEAT-{NNN}）を実装するか
2. **プロジェクト ID の確認**: PRJ-{NNN} と出力先ディレクトリ
3. **実装範囲の確認**: バックエンドのみ / フロントエンドのみ / 両方
4. **FEAT 間依存の確認**: 依存する他の FEAT-ID が未実装でないか（DSD-001/002 の依存関係セクションを確認）
5. **初回構築かどうか**: IMP-003（環境構築手順書）が必要か

## 入力ドキュメントの読み込み方針

TDD では設計書を一括で読み込まない。**次のテストを書くのに必要な箇所だけ**その都度参照する。

```
最初に読む（スコープ把握のみ）
  docs/DSD/_common/DSD-007_coding-guidelines.md              ← コーディング規約（システム共通）
  docs/DSD/FEAT-{NNN}_{機能名}/DSD-008_{FEAT-ID}_{機能名}.md ← テストケース一覧を把握する

各イテレーションで必要に応じて参照する
  DSD-001 / DSD-002 ← 現在のテストケースが対象とするクラス/コンポーネントの仕様のみ読む
  DSD-003           ← 現在のテストケースが対象とする API エンドポイントの仕様のみ読む
  DSD-004           ← DB アクセスが必要になったときに読む
  DSD-005 / DSD-006 ← 外部IF・バッチが必要になったときに読む
```

> **アンチパターン**: 全 DSD を読んでから実装を始めない。読みすぎると設計を先取りしてしまい TDD の効果が失われる。

## TDD マイクロサイクル（1イテレーション = 1テスト）

詳細パターン・アンチパターン・テストダブル・FIRST 原則 → `references/tdd-workflow.md`

### ステップ 1: テストリストを作る（TODOリスト）

DSD-008 のテストケース一覧を **テキストの TODO リスト** に変換する。まだコードは書かない。

```
[ ] 有効なメールアドレスとパスワードでユーザーを登録できる  ← まずこれ
[ ] パスワードが8文字未満の場合はバリデーションエラーになる
[ ] 既存のメールアドレスは重複エラーになる
...（実装中に気づいたケースを随時追記していく）
```

- リストから **最も簡単な正常系（条件分岐なし・外部依存なし）** を1つ選ぶ
- 実装中に新しいケースに気づいたら **作業を止めず** にリストへ追記する
- リストが空になったら Done

### ステップ 2: Red（1テストだけ書く）

1. 選んだテストケース **1つだけ** を Arrange-Act-Assert の構造で書く
2. 実装コードは書かない状態でテストを実行し、**意図した理由で失敗すること**を確認する
3. テスト名は「〜の場合〜になる」形式で振る舞いを記述し、先頭に DSD-008 の ID を付ける

```python
def test_TC001_有効なメールアドレスとパスワードでユーザーを登録できる():
    # Arrange
    service = UserService(InMemoryUserRepository())
    # Act
    result = service.register("user@example.com", "Password123")
    # Assert
    assert result.is_success is True
```

> **アンチパターン**: 複数のテストを一度に書かない。1サイクル1テスト。

### ステップ 3: Green（実装戦略を選んで最小の実装）

3つの戦略から選ぶ：

| 戦略 | 使いどき |
|---|---|
| **仮実装** | 迷ったとき・不安なとき → ハードコードで通す |
| **三角測量** | 仮実装の後 → ハードコードを壊す2つ目のテストを追加 |
| **明白な実装** | 実装が自明なとき → 最初から正しい実装を書く |

- GREEN にならなかった場合（明白な実装が失敗）→ 仮実装に戻る
- 設計との差異が生じた場合はメモしておく

> **アンチパターン**: 「どうせ必要になるから」と先に汎用的な実装を書かない。

### ステップ 4: Refactor（DSD-007 に従い整える）

1. DSD-007（コーディング規約）に従い命名・構造を整える
2. 全テストが引き続き GREEN であることを確認する
3. 振る舞いを変えない範囲のみ整理する

### ステップ 5: 次のテストを選んで繰り返す

**次のテストは、現在の実装を壊すものを選ぶ。**

- 仮実装（ハードコード）で通っている場合 → そのハードコードが失敗するテストを選ぶ（三角測量）
- 正常系が終わった場合 → 境界値・異常系・例外系へ進む
- テストリストの全ケースが GREEN になるまでステップ 2〜4 を繰り返す

## DB マイグレーション

DSD-004 を元に、マイグレーションスクリプトを作成する。

**並行作業時の手順**:
1. 各 FEAT セッションは自分の担当分を `IMP-004_FEAT-{NNN}_draft.md` として作成する（`references/imp-templates.md` の IMP-004 テンプレートを使用）
2. 全 FEAT-ID の実装完了後、実行順序（テーブル依存関係）を調整して `IMP-004_db-migration.md` に統合する
3. 統合時に FEAT 間のテーブル依存（外部キー参照など）を考慮した実行順序を確定する

## 出力ドキュメントの作成

`references/imp-templates.md` のテンプレートを使い、機能ごとに以下を作成する：

| ドキュメント | 作成タイミング | 配置先 | 並行作業 |
|---|---|---|---|
| IMP-001_{FEAT-ID}_{機能名}.md | BE TDD サイクル完了後 | `projects/PRJ-{NNN}/IMP/FEAT-{NNN}_{機能名}/` | 各 FEAT 独立 |
| IMP-002_{FEAT-ID}_{機能名}.md | FE TDD サイクル完了後 | `projects/PRJ-{NNN}/IMP/FEAT-{NNN}_{機能名}/` | 各 FEAT 独立 |
| IMP-003_environment-setup.md | 初回構築時のみ（1セッションで作成） | `projects/PRJ-{NNN}/IMP/` | 単独作成 |
| IMP-004_FEAT-{NNN}_draft.md | DB 変更がある FEAT の TDD 完了後 | `projects/PRJ-{NNN}/IMP/` | 各 FEAT 独立で下書き作成 |
| IMP-004_db-migration.md | 全 FEAT 完了後に統合 | `projects/PRJ-{NNN}/IMP/` | draft をマージして完成 |
| IMP-005_tdd-defect-list.md | TDD 中に不具合が発生した都度更新 | `projects/PRJ-{NNN}/IMP/` | 全 FEAT 共通（随時追記） |

## 設計差異の記録原則

実装中に DSD との差異が生じた場合：
1. 差異内容・理由を記録する（IMP-001/002 の「設計差異一覧」に記載）
2. 差異が設計変更を要する場合はユーザーに確認し、必要なら DSD を更新する
3. 既知の制限事項（将来対応）は「既知の制限事項」セクションに記載する

---
name: unit-test
description: |
  単体テスト（TDD）スキル。詳細設計書の単体テスト設計書（DSD-008）を入力とし、テスト駆動開発（TDD）の Red→Green→Refactor サイクルでテストを先行して書き、実装を駆動する。

  以下の場合に使用する：
  - TDD サイクルでテストを書きながら実装を進める場合
  - テストリストの管理・テストケースの設計
  - テストダブル（Stub / Mock / Fake 等）の選定・実装
  - FIRST 原則に基づくテスト品質の担保

  このスキルは実装スキル（skills/implementation/）と連携して使用する。
  実装エージェントは本スキルと実装スキルの両方を読み込んで作業する。

  入力: docs/DSD/ 以下の DSD-008（単体テスト設計書）
  出力: テストコード・テスト結果（IMP-001/IMP-002 のテスト結果セクションに記載）
  配置ルール・ドキュメント定義 → references/document-list.md
---

# 単体テストスキル（TDD）

## 概要

DSD-008（単体テスト設計書）を起点に、TDD の Red→Green→Refactor サイクルでテストを先行して書き、実装を駆動する方法論を提供する。

参照ファイル：
- TDD サイクル詳細・テストダブル・FIRST 原則・アンチパターン → `references/tdd-workflow.md`
- テスト結果テンプレート断片・TDD 不具合管理票テンプレート → `references/ut-templates.md`
- 配置ルール・ドキュメント定義 → `references/document-list.md`

## 並行作業スコープ

**このスキルは 1回の起動で 1つの FEAT-ID を担当する。**
複数の FEAT-ID は別セッションで並行して進める（実装スキルと同じ）。

## 入力ドキュメント読み込み方針

TDD では設計書を一括で読み込まない。**次のテストを書くのに必要な箇所だけ**その都度参照する。

```
最初に読む（テストスコープの把握）
  docs/DSD/FEAT-{NNN}_{機能名}/DSD-008_{FEAT-ID}_{機能名}.md ← テストケース一覧を把握する

各イテレーションで必要に応じて参照する（テストの観点で）
  DSD-001 / DSD-002 ← 現在のテストケースが対象とするクラス/コンポーネントの期待される振る舞いを確認する
  DSD-003           ← 現在のテストケースが対象とする API エンドポイントの仕様を確認する
  DSD-004           ← DB アクセスに関するテストを書くときに読む
  DSD-005 / DSD-006 ← 外部IF・バッチに関するテストを書くときに読む
```

> **アンチパターン**: 全 DSD を読んでからテストを書き始めない。読みすぎると設計を先取りしてしまい TDD の効果が失われる。

## テストリスト管理（TODOリスト）

DSD-008 のテストケース一覧を **テキストの TODO リスト** に変換する。まだコードは書かない。

```
[ ] 有効なメールアドレスとパスワードでユーザーを登録できる  ← まずこれ
[ ] パスワードが8文字未満の場合はバリデーションエラーになる
[ ] 既存のメールアドレスは重複エラーになる
...（実装中に気づいたケースを随時追記していく）
```

- リストから **最も簡単な正常系（条件分岐なし・外部依存なし）** を1つ選ぶ
- 実装中に新しいケースに気づいたら **作業を止めず** にリストへ追記する
- リストが空になったら Done

## TDD マイクロサイクル（1イテレーション = 1テスト）

詳細パターン・アンチパターン・テストダブル・FIRST 原則 → `references/tdd-workflow.md`

### ステップ 1: テストリストを作る（TODOリスト）

DSD-008 のテストケース一覧を **テキストの TODO リスト** に変換する。まだコードは書かない。

- リストから **最も簡単な正常系（条件分岐なし・外部依存なし）** を1つ選ぶ
- 実装中に新しいケースに気づいたら **作業を止めず** にリストへ追記する
- リストが空になったら Done

### ステップ 2: Red（1テストだけ書く）

1. 選んだテストケース **1つだけ** を Arrange-Act-Assert の構造で書く
2. 実装コードは書かない状態でテストを実行し、**意図した理由で失敗すること**を確認する
3. テスト名は「〜の場合〜になる」形式で振る舞いを記述し、先頭に DSD-008 の ID を付ける

```python
def test_TC001_有効なメールアドレスとパスワードでユーザーを登録できる():
    # Arrange
    service = UserService(InMemoryUserRepository())
    # Act
    result = service.register("user@example.com", "Password123")
    # Assert
    assert result.is_success is True
```

> **アンチパターン**: 複数のテストを一度に書かない。1サイクル1テスト。

### ステップ 3: Green（実装戦略を選んで最小の実装）

3つの戦略から選ぶ：

| 戦略 | 使いどき |
|---|---|
| **仮実装** | 迷ったとき・不安なとき → ハードコードで通す |
| **三角測量** | 仮実装の後 → ハードコードを壊す2つ目のテストを追加 |
| **明白な実装** | 実装が自明なとき → 最初から正しい実装を書く |

- GREEN にならなかった場合（明白な実装が失敗）→ 仮実装に戻る
- 設計との差異が生じた場合はメモしておく

> **アンチパターン**: 「どうせ必要になるから」と先に汎用的な実装を書かない。

### ステップ 4: Refactor（DSD-007 に従い整える）

1. DSD-007（コーディング規約）に従い命名・構造を整える
2. 全テストが引き続き GREEN であることを確認する
3. 振る舞いを変えない範囲のみ整理する

### ステップ 5: 次のテストを選んで繰り返す

**次のテストは、現在の実装を壊すものを選ぶ。**

- 仮実装（ハードコード）で通っている場合 → そのハードコードが失敗するテストを選ぶ（三角測量）
- 正常系が終わった場合 → 境界値・異常系・例外系へ進む
- テストリストの全ケースが GREEN になるまでステップ 2〜4 を繰り返す

## テスト完了の定義

テストの観点での Done 基準：

```
□ テストリストが全て ✅（DSD-008 の全テストケースが GREEN）
□ テスト名が振る舞いを記述している（「〜の場合〜になる」形式）
□ テストが FIRST 原則を満たしている（Fast / Independent / Repeatable / Self-validating / Timely）
□ テストダブルの選択が適切（Mock の多用を避け、Stub + 状態検証を優先）
□ IMP-001/002 のテスト結果セクションに結果を記載した
□ TDD 中に発見した不具合を IMP-005（TDD不具合管理票）に記録した
```

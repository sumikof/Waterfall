# DSD-005 外部インターフェース詳細設計書 テンプレート

> このドキュメントは外部システム連携がある機能のみ作成する。
> BSD-007（外部インターフェース基本設計書）が存在し、REQ-005 の当該機能に外部IF使用の記載がある場合に作成する。

## 目次
1. 対象外部システム
2. 外部IF詳細仕様
3. エラーハンドリング詳細
4. 後続フェーズへの影響

---

## セクション構成

```markdown
## 1. 対象外部システム

（BSD-007 からこの機能（FEAT-ID）に関係する外部システムを抽出）

| 外部システムID | システム名 | 通信方向 | 用途 |
|---|---|---|---|
| EXT-001 | {システム名} | 送信 / 受信 / 双方向 | {用途} |

---

## 2. 外部IF詳細仕様

### 2.1 {外部システムID}: {システム名}

**通信方向:** 送信 / 受信 / 双方向
**ベースURL:** `https://api.example.com/v1`
**認証方式:** APIキー（`X-API-Key` ヘッダー） / OAuth 2.0 / Basic認証

#### 2.1.1 {操作名}

**概要:** {処理の説明}
**HTTPメソッド:** GET / POST / PUT / DELETE
**エンドポイント:** `/endpoint/path`

**リクエストヘッダー:**
```http
Content-Type: application/json
X-API-Key: {API_KEY}
X-Request-Id: {UUID}
```

**リクエストボディ:**
```json
{
  "param1": "value1",
  "param2": 123,
  "param3": true
}
```

| フィールド名 | 型 | 必須 | 説明 | 制約 |
|---|---|---|---|---|
| `param1` | string | ○ | パラメータ1 | 最大50文字 |
| `param2` | integer | ○ | パラメータ2 | 1以上 |
| `param3` | boolean | × | パラメータ3 | - |

**レスポンス（成功 200）:**
```json
{
  "status": "success",
  "data": {
    "result": "value",
    "transactionId": "TXN-12345"
  }
}
```

| フィールド名 | 型 | 説明 |
|---|---|---|
| `status` | string | 処理結果 (`success` / `error`) |
| `data.result` | string | 処理結果値 |
| `data.transactionId` | string | 外部システム側のトランザクションID |

**外部システムのエラーコード:**
| ステータス | エラーコード | 説明 | 自システムでの対処 |
|---|---|---|---|
| 400 | `INVALID_PARAM` | パラメータ不正 | バリデーション見直し・ログ記録 |
| 401 | `AUTH_FAILED` | 認証失敗 | APIキー確認・アラート通知 |
| 429 | `RATE_LIMIT` | レート制限超過 | バックオフリトライ |
| 503 | `SERVICE_UNAVAILABLE` | 外部システム停止 | サーキットブレーカー発動 |

---

## 3. エラーハンドリング詳細

### 3.1 リトライ設計

| リトライ対象 | 最大リトライ回数 | 待機時間 | バックオフ方式 |
|---|---|---|---|
| タイムアウト | 3回 | 1秒→2秒→4秒 | 指数バックオフ |
| 5xx エラー | 3回 | 1秒→2秒→4秒 | 指数バックオフ |
| 429 レート制限 | 3回 | `Retry-After` ヘッダー値 | 固定 |

**リトライしない条件:**
- 4xx エラー（クライアント側の問題）
- 認証エラー（401）

### 3.2 サーキットブレーカー設計

| 設定項目 | 値 |
|---|---|
| エラー閾値 | 直近10リクエスト中5回以上失敗 |
| 開放（Open）状態の継続時間 | 30秒 |
| ハーフオープン時の試行数 | 1リクエスト |

**外部システム障害時の縮退動作:**
- {縮退動作1: 例: キューに積んで後続処理}
- {縮退動作2: 例: ユーザーにエラー表示・手動再実行を案内}

### 3.3 タイムアウト設定

| タイムアウト種別 | 設定値 |
|---|---|
| 接続タイムアウト | 5秒 |
| 読み取りタイムアウト | 30秒 |
| 全体タイムアウト | 35秒 |

### 3.4 ログ・監視

| ログ対象 | ログレベル | 内容 |
|---|---|---|
| リクエスト送信 | INFO | エンドポイント・リクエストID・タイムスタンプ |
| レスポンス受信（成功） | INFO | ステータス・処理時間 |
| リトライ発生 | WARN | エラー内容・リトライ回数 |
| 全リトライ失敗 | ERROR | エラー詳細・入力パラメータ（機密情報除く） |
| サーキットブレーカー発動 | ERROR | アラート通知 |

---

## 4. 後続フェーズへの影響

| 影響先 | 内容 |
|---|---|
| IMP-001_{FEAT-ID} | 外部IF呼び出し実装（HTTPクライアント・リトライ・CB） |
| IT-001_{FEAT-ID} | 外部システムスタブ/モックを使った結合テスト |
```
